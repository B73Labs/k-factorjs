<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>LIN_ADVANCE K-Factor Test Pattern Generator</title>
<script>
function gengcode (form) {
	document.forms['form1']['textarea'].value = '';
	document.forms['form1']['textarea'].value = 	'; K-Factor Test\n' +
													';\n' +
													'M190 S' + document.forms['form1']['BED_TEMP'].value + ' ; set and wait for bed temp\n' +
													'M104 S' + document.forms['form1']['NOZZLE_TEMP'].value + ' ; set nozzle temp and continue\n' +
													'G28 ; home all axes\n';
	
	if(document.getElementById('USE_UBL').checked) {
    document.forms['form1']['textarea'].value += 	'G29 ; execute bed automatic leveling compensation\n';
    }
	
	var START_K = parseInt(document.forms['form1']['K_START'].value);
	var END_K = parseInt(document.forms['form1']['K_END'].value);
	var STEP_K = parseInt(document.forms['form1']['K_STEP'].value);
	var RANGE_K =  END_K - START_K;
	if (RANGE_K % STEP_K != 0) {
		alert("Your K-Factor range cannot be cleanly divided. Check Start / End / Steps for the K-Factor");
		document.forms['form1']['textarea'].value = '';
		return;
	}
	var PRINT_SIZE_Y = RANGE_K / STEP_K * 5 + 25;
	if (PRINT_SIZE_Y > parseFloat(document.forms['form1']['BEDSIZE_Y'].value) - 20) {
		alert("Your K-Factor settings exceed your Y bed size. Check Start / End / Steps for the K-Factor");
		document.forms['form1']['textarea'].value = '';
		return;
	}
	var START_Y = (parseFloat(document.forms['form1']['BEDSIZE_Y'].value) - PRINT_SIZE_Y) / 2;
	
	document.forms['form1']['textarea'].value += 	'M109 S' + document.forms['form1']['NOZZLE_TEMP'].value + ' ; block waiting for nozzle temp\n' +
													'G21 ; set units to millimeters\n' +
													'M204 S500 ; lower acceleration to 500mm/s2 during the test\n' +
													'M83 ; use relative distances for extrusion\n' + 
													'G90 ; use absolute coordinates\n' +
													';\n' +
													'; go to layer height and prime nozzle on a line to the left\n' +
													';\n' +
													'G1 X20 Y' + START_Y + ' F' + document.forms['form1']['MOVE_SPEED'].value + '\n' +
													'G1 Z' + document.forms['form1']['LAYER_HEIGHT'].value + ' F' + document.forms['form1']['SLOW_SPEED'].value + '\n' +
													'G1 X20 Y' + (START_Y + 100) + ' E10' + ' F' + document.forms['form1']['SLOW_SPEED'].value + ' ; extrude some to start clean\n' +
													'G1 E-' + document.forms['form1']['RETRACTION'].value + '\n' +
													';\n' +
													'; start the test (all values are relative coordinates)\n' +
													';\n' +
													'G1 X' + ((parseFloat(document.forms['form1']['BEDSIZE_X'].value) - 80) / 2) + ' Y' + START_Y + ' F' + document.forms['form1']['MOVE_SPEED'].value + ' ; move to pattern start\n' +
													'G91 ; use relative coordinates\n';
	
	var NOZZLE_LINE_RATIO = "1.2";
	var EXTRUSION_RATIO = parseFloat(document.forms['form1']['NOZ_DIA'].value) * NOZZLE_LINE_RATIO * parseFloat(document.forms['form1']['LAYER_HEIGHT'].value) / (Math.pow((parseFloat(document.forms['form1']['FIL_DIA'].value) / 2),2) * Math.PI);
	var EXT_20 = roundNumber(EXTRUSION_RATIO * parseFloat(document.forms['form1']['EXTRUSION_MULT'].value) * 20, 5);
	var EXT_40 = roundNumber(EXTRUSION_RATIO * parseFloat(document.forms['form1']['EXTRUSION_MULT'].value) * 40, 5);
	
	
	for (i = START_K; i <= END_K; i = i + STEP_K) {
    	document.forms['form1']['textarea'].value += 'M900 K' + i + ' ; set K-factor\n' +
													 'G1 E' + document.forms['form1']['RETRACTION'].value + '\n' +
													 'G1 X20 Y0 E' + EXT_20 + ' F' + document.forms['form1']['SLOW_SPEED'].value + '\n' +
													 'G1 X40 Y0 E' + EXT_40 + ' F' + document.forms['form1']['FAST_SPEED'].value + '\n' +
													 'G1 X20 Y0 E' + EXT_20 + ' F' + document.forms['form1']['SLOW_SPEED'].value + '\n' +
													 'G1 E-' + document.forms['form1']['RETRACTION'].value + '\n' +
													 'G1 X-80 Y5 F' + document.forms['form1']['MOVE_SPEED'].value + '\n';
	}
	
	document.forms['form1']['textarea'].value += 	';\n' +
													'; mark the test area for reference\n' +
													';\n' +
													'G1 X20 Y0 F' + document.forms['form1']['MOVE_SPEED'].value + '\n' +
													'G1 E' + document.forms['form1']['RETRACTION'].value + '\n' +
													'G1 X0 Y20 E' + EXT_20 + ' F' + document.forms['form1']['SLOW_SPEED'].value + '\n' +
													'G1 E-' + document.forms['form1']['RETRACTION'].value + '\n' +
													'G1 X40 Y-20 F' + document.forms['form1']['MOVE_SPEED'].value + '\n' +
													'G1 E' + document.forms['form1']['RETRACTION'].value + '\n' +
													'G1 X0 Y20 E' + EXT_20 + ' F' + document.forms['form1']['SLOW_SPEED'].value + '\n' +
													'G1 E-' + document.forms['form1']['RETRACTION'].value + '\n' +
													';\n' +
													'; finish\n' +
													';\n' +
													'G4 ; wait\n' +
													'M104 S0 ; turn off hotend\n' +
													'M140 S0 ; turn off bed\n' +
													'G90 ; use absolute coordinates\n' +
													'G1 Z30 Y200 F' + document.forms['form1']['MOVE_SPEED'].value + ' ; move away from the print\n' +
													'M84 ; disable motors\n' +
													'M502 ; resets parameters from ROM (for those who do not have an EEPROM)\n' +
													'M501 ; resets parameters from EEPROM (preferably)\n' +
													';';
}
// https://stackoverflow.com/questions/21479107/saving-html5-textarea-contents-to-file
function saveTextAsFile(form) {
  	var textToWrite = document.getElementById('textarea').value;
	var textFileAsBlob = new Blob([ textToWrite ], { type: 'text/plain' });
  	var fileNameToSaveAs = "kfactor.gcode";

	var downloadLink = document.createElement("a");
	downloadLink.download = fileNameToSaveAs;
	downloadLink.innerHTML = "Download File";
	if (window.webkitURL != null) {
		// Chrome allows the link to be clicked without actually adding it to the DOM.
		downloadLink.href = window.webkitURL.createObjectURL(textFileAsBlob);
	} else {
		// Firefox requires the link to be added to the DOM before it can be clicked.
		downloadLink.href = window.URL.createObjectURL(textFileAsBlob);
		downloadLink.onclick = destroyClickedElement;
		downloadLink.style.display = "none";
		document.body.appendChild(downloadLink);
	}

	downloadLink.click();
}
function destroyClickedElement(event) {
  	// remove the link from the DOM
  	document.body.removeChild(event.target);
}

// https://stackoverflow.com/questions/11832914/round-to-at-most-2-decimal-places-only-if-necessary
function roundNumber(num, scale) {
  if(!("" + num).includes("e")) {
    return +(Math.round(num + "e+" + scale)  + "e-" + scale);
  } else {
    var arr = ("" + num).split("e");
    var sig = ""
    if(+arr[1] + scale > 0) {
      sig = "+";
    }
    return +(Math.round(+arr[0] + "e" + sig + (+arr[1] + scale)) + "e-" + scale);
  }
}
	
</script>
<noscript>You have to activate javascript for this to work</noscript>
</head>
<body>
<form id="form1" name="form1" method="get">
  <table width="90%" border="1">
    <tbody>
      <tr>
        <td width="62%"><strong>Settings: </strong></td>
        <td width="38%"><label for="textarea"><strong>GCode:</strong><br></label></td>
      </tr>
      <tr>
        <td><table width="100%" border="1">
          <tbody>
            <tr>
              <td valign="middle"><label for="FIL_DIA">Filament Diameter:</label></td>
              <td valign="middle"><input type="number" name="FIL_DIA" id="FIL_DIA" value="1.75"></td>
              <td valign="middle">Diameter of the used filament in mm</td>
            </tr>
            <tr>
              <td valign="middle"><label for="NOZ_DIA">Nozzle Diameter:</label></td>
              <td valign="middle"><input type="number" name="NOZ_DIA" id="NOZ_DIA" value="0.4"></td>
              <td valign="middle">Diameter of the nozzle in mm</td>
            </tr>
            <tr>
              <td width="20%" valign="middle"><label for="NOZZLE_TEMP">Nozzle Temperature:</label></td>
              <td width="14%" valign="middle"><input type="number" name="NOZZLE_TEMP" id="NOZZLE_TEMP" value="205"></td>
              <td width="66%" valign="middle">Nozzle Temperature in °C</td>
            </tr>
            <tr>
              <td valign="middle"><label for="BED_TEMP">Bed Temperature:</label></td>
              <td valign="middle"><input type="number" name="BED_TEMP" id="BED_TEMP" value="60"></td>
              <td valign="middle">Bed Temperature in °C</td>
            </tr>
            <tr>
              <td valign="middle"><label for="SLOW_SPEED">Slow printing speed:</label></td>
              <td valign="middle"><input type="number" name="SLOW_SPEED" id="SLOW_SPEED" value="1200"></td>
              <td valign="middle">Slow printing speed in mm/min</td>
            </tr>
            <tr>
              <td valign="middle"><label for="FAST_SPEED">Fast printing speed:</label></td>
              <td valign="middle"><input type="number" name="FAST_SPEED" id="FAST_SPEED" value="4200"></td>
              <td valign="middle">Slow printing speed in mm/min</td>
            </tr>
            <tr>
              <td valign="middle"><label for="MOVE_SPEED">Movement Speed:</label></td>
              <td valign="middle"><input type="number" name="MOVE_SPEED" id="MOVE_SPEED" value="7200"></td>
              <td valign="middle">Movement speed in mm/min</td>
            </tr>
            <tr>
              <td valign="middle"><label for="USE_UBL">Use Bed Levelling:</label></td>
              <td valign="middle"><input type="checkbox" name="USE_UBL" id="USE_UBL"></td>
              <td valign="middle">Activate UBL and level bed before printing</td>
            </tr>
            <tr>
              <td valign="middle"><label for="RETRACTION">Retraction:</label></td>
              <td valign="middle"><input type="number" name="RETRACTION" id="RETRACTION" value="1.000"></td>
              <td valign="middle">Retraction distance in mm</td>
            </tr>
            <tr>
              <td valign="middle"><label for="BEDSIZE_X">Bed size X:</label></td>
              <td valign="middle"><input type="number" name="BEDSIZE_X" id="BEDSIZE_X" value="200"></td>
              <td valign="middle">Size in mm of the bed in X</td>
            </tr>
            <tr>
              <td valign="middle"><label for="BEDSIZE_Y">Bed Size Y:</label></td>
              <td valign="middle"><input type="number" name="BEDSIZE_Y" id="BEDSIZE_Y" value="200"></td>
              <td valign="middle">Size in mm of the bed in Y</td>
            </tr>
            <tr>
              <td valign="middle"><label for="LAYER_HEIGHT">Layer Height:</label></td>
              <td valign="middle"><input type="number" name="LAYER_HEIGHT" id="LAYER_HEIGHT" value="0.200"></td>
              <td valign="middle">Layer Height in mm</td>
            </tr>
            <tr>
              <td valign="middle"><label for="EXTRUSION_MULT">Extrusion Multiplier:</label></td>
              <td valign="middle"><input type="number" name="EXTRUSION_MULT" id="EXTRUSION_MULT" value="1.0"></td>
              <td valign="middle">Usually 1.0</td>
            </tr>
            <tr>
              <td valign="middle"><label for="K_START">Starting value for K:</label></td>
              <td valign="middle"><input type="number" name="K_START" id="K_START" value="0"></td>
              <td valign="middle">Starting value for the K-Factor. Usually 0 but for bowden setups you might want to start higher, e.g. 30</td>
            </tr>
            <tr>
              <td valign="middle"><label for="K_END">Ending value for K:</label></td>
              <td valign="middle"><input type="number" name="K_END" id="K_END" value="100"></td>
              <td valign="middle">Ending value of the K-Factor.</td>
            </tr>
            <tr>
              <td valign="middle"><label for="K_STEP">K-Factor Stepping:</label></td>
              <td valign="middle"><select name="K_STEP" id="K_STEP">
                <option value="5" selected>5</option>
                <option value="10">10</option>
              </select></td>
              <td valign="middle">Stepping of the K-Factor in the test pattern</td>
            </tr>
          </tbody>
        </table>
        <p>
          <input name="button" type="button" id="button" form="form1" value="Generate GCode" onClick="gengcode(this.form)">
        </p></td>
        <td>
          <p>
            <textarea name="textarea" cols="120" rows="40" id="textarea"></textarea>
          </p>
        <p>
          <input type="button" name="button2" id="button2" value="Download as file" onClick="saveTextAsFile(this.form)">
        </p></td>
      </tr>
    </tbody>
  </table>
</form>
</body>
</html>
